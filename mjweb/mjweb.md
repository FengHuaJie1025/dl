<h1 align="center"><a href="" target="_blank">mj-web</a></h1>
> mj中心的管理后台

------------------------------

**项目开发流程：**

![完整的项目开发流程](./static/完整的项目开发流程.jpg)



## 0、需求文档

> [需求文档，其实这样很完整](https://www.jianshu.com/p/cffbdffb72e4)
>
> [产品需求文档：抖音短视频](http://www.woshipm.com/evaluating/3149870.html)
>
> [产品需求文档：滴滴快车业务](http://www.woshipm.com/evaluating/3384287.html)

### **基于Springboot对mj中心的管理后台进行改造**

功能包括：
1. 统计报表：对用户行为、广告情况、设备情况、客户项目等数据进行统计，生成报表，方便决策。
   - 通过Mysql事件调度器（Event Scheduler），Mysql定时自己执行
   - 通过MySQL Trigger， log数据表每次插入时执行整理操作
   - 通过编程语言连接数据库，在编程语言中整理数据并插入数据表，同时用守护进程运行这个程序。
     前两种方法可以比较好的保证数据的完整性，但是统计数据量比较大，SQL的编写也比较有难度。
   
2. 系统管理：对账号、角色、权限、操作记录、异常日志进行管理。
   - 使用RBAC（基于角色的访问控制）设计
   - 操作记录、异常日志使用切面进行记录
   
3. 项目管理：对客户项目、小区楼栋信息等进行增删改查。

4. 员工管理：对物业员工的账号进行管理、审核、编辑。

5. 住户管理：对住户的账号进行管理、审核、编辑。

6. 门卡管理：把卡片和设备进行绑定，使用户可以通过卡片进行开门，包括把卡片绑定到设备和把设备信息写入卡片。
   - 把卡片绑定到设备中：通过excel表把住户的卡号信息与房间信息导入到系统中，系统查询到该房间所关联的设备，将卡号写入到设备中。
   - 把设备信息写入到卡片：通过网络发卡机给卡片第三扇区加密并写入设备信息
   
7. 访客管理：对访客日志进行查询。

8. 设备管理：对门禁设备、发卡机设备、供应商、品牌信息进行管理。

9. 设备日志：手机开门日志、访客码开门日志。

   - 数据过多，sql性能有问题导致数据库执行过慢发生超时。（阿里推荐单表不超过500W条记录）

   - 解决方案：分库分表

   - 带来的问题：库表过多，查询、统计变得困难（

     **join操作**：水平分表后，虽然物理上分散在多个表中，如果需要与其它表进行join查询，需要在业务代码或者数据库中间件中进行多次join查询，然后将结果合并。

     **COUNT(\*)操作**：水平分表后，某些场景下需要将这些表当作一个表来处理，那么count(\*)显得没有那么容易 了。

     **order by 操作**：分表后，数据分散到多个表中，排序操作无法在数据库中完成，只能由业务代码或数据中间件分别查询每个子表中的数据，然后汇总进行排序）

10. 社区服务：提供物业报修、生活缴费、保洁等服务。

11. 通知管理：app通知推送。

12. 广告管理：对广告商、广告、广告日志等进行管理。

13. 客户端管理：管理客户端的版本要求、更新链接、更新说明等。

14. 帮助反馈：常见问题Q&A。


## 1、需求评审
> [如何做需求评审](http://www.woshipm.com/pmd/304966.html)
需求就是用户对目标系统在功能、行为、性能、设计约束等方面的期望。

需求分析就是发现需求、建模并定义需求的过程

需求分析将创建数据模型、功能模型、控制模型

可用工具：数据流图、数据字典、E-R图

**需求规格说明书的主要内容（GB856T--88）：**

- 功能需求：软件需要执行什么功能
- 性能需求：定量描述软件系统满足的具体性能要求
- 外部接口：软件如何与人、系统的硬件及其他硬件、软件进行交互
- 属性：正确性、可用性、可靠性、安全性、可维护性
- 约束条件：使用的标准、编程语言、数据库完整方针、资源限制、运行环境

**为什么要做需求评审**

- 让与会者清晰的了解需求是什么，需求从哪里来，对现有业务有什么影响，预期收益是什么；
- 让技术及测试对产品方案有详细的了解，以便后续开发更高效，没有谁愿意在后续的编写测试用例及开发阶段再去反复沟通确认，毕竟那是非常低效的做法，当然，特殊情况除外；
- 让与会者清晰的知道自己在整个方案落地过程中处于什么位置，职责是什么，需要做什么，准备什么，提供什么帮助，对各自负责部分的实现难度及排期有一定的心理预期；
- 评估产品方案的技术难度及实现周期，一期实现，还是分期实现，投入产出比怎么样？毕竟互联网产品讲究小步快跑，快速验证迭代，怎么样权衡产品设计（用户体验），技术成本以及商业利益是产品经理主要工作之一。

## 2、交互设计评审
> [如何设计交互](https://www.uisdc.com/interactive-self-checklist)

根据产品文字需求转换成的可视化的原型，其中涵盖了产品操作流程（重点设计主要任务和流程，但是分支流程和异常流程也要考虑），具体的产品逻辑说明已经页面布局说明等
交互设计评审顾名思义就是召集整个产品的团队包括产品技术研发视觉测试人员等对交互设计师的产品进行讨论，从而达到对整个交互设计的统一认知，最后形成产品开发和视觉设计标准，可以说交互设计方案的落地是整个产品雏形的最重要一环。

## 3、概要设计

> [软件概要设计做什么](https://www.cnblogs.com/isAndyWu/p/10410324.html)
>
> [一份全面的概要设计书是怎样的](http://www.woshipm.com/pd/2521033.html)
>
> [软件概要设计](https://www.cnblogs.com/youcong/p/9500921.html)
>
> [if 我是前端团队 Leader，怎么做好概要设计](https://juejin.im/post/5d71cec6e51d4561b674c4d0#heading-17)

### **软件设计的主要目标 :**

付出较低的开发成本

达到要求的软件功能

取得较好的软件性能

开发的软件容易移植

需要较低的维护费用

及时开发及时交付

### **软件设计的基本任务 :**

软件概要设计就是设计出软件的总体结构框架，定义实现需求的工作产品技功能、技术构架，定义设计准则及共通处理方针，分解划分功能模块，定义各功能模块的功能和业务处理，定义模块间的接口关系。典型的工作产品有《概要设计书》、《设计准则》及《共通处理方针》。一般包括系统技术构架，机能一览，机能迁移图，数据库逻辑设计，数据文件逻辑定义，系统各单位功能模块及接口定义，设计准则及共通处理方针（外观、操作、错误处理、日志、提示信息、异常处理、命名规约、编码规约等方针）等内容。而后对结构的进一步细化的设计就是软件的详细设计或过程设计。

软件概要设计阶段要做的事情是什么呢? 总的来看有四个方面:它们是 

​    1、设计软件系统结构(软件结构) 

​    2、数据结构及数据库设计 

​    3、编写概要设计文档 

​    4、评审

在需求分析阶段，已经把系统分解成层次结构，而在概要设计阶段，需要进一步分解，划分为模块以及模块的层次结构。划分的具体过程是:

(1)采用某种设计方法，将一个复杂的系统按功能划分成模块。 

(2)确定每个模块的功能。 

(3)确定模块之间的调用关系。 

(4)确定模块之间的接口，即模块之间传递的信息。

(5)评价模块结构的质量。

最后一个任务就是评审，在概要设计中，对设计部分是否完整地实现了需求中规定的功能、性能等要求，设计方案的可行性，关键的处理及内外部接口定义正确性、有效性，各部分之间的一致性等都要进行评审，以免在以后的设计中发现大的问题而返工。



### **软件设计的基本原理 :**

1、模块化

模块化就是指解决一个复杂问题时自顶向下，逐步求精逐层把软件系统划分成若干模块的过程。

为了解决复杂的问题，在软件设计中就必须把整个问题进行分解来降低复杂性，这样就可以减少开发工作量并降低开发成本和提高软件生产率.

2、抽象

在软件结构设计中的模块分层也是由抽象到具体的分析和构造出来的。

3、信息隐蔽

信息隐蔽的意思是，在设计和确定模块时，使得一个模块内包含的信息，对于不需要这些信息的其他模块来说是不能访问的。在软件设计中，模块的划分也要采取措施使他实现信息隐蔽。

4、模块独立性

模块独立性指每个模块只完成系统要求的独立的子功能，并且与其他模块的联系最少且接口简单。（低耦合高内聚）



### **软件结构的优化准则：**

1、模块的划分：高内聚、低耦合，保证相对独立性。

2、模块的范围：模块的作用范围要在他的控制范围内，其所在的模块应该与其控制的模块在层次上尽量靠近。

3、形成的结构：软件结构的深度、宽度、扇入、扇出要适当

- 扇入：是指直接调用该模块的上级模块的个数。扇入大表示模块的复用程序高。 

- 扇出：是指该模块直接调用的下级模块的个数。扇出大表示模块的复杂度高，需要控制和协调过多的下级模块；但扇出过小（例如总是1）也不好。

4、模块的大小：要适中。

5、模块的接口：简单清晰、容易理解、实现、测试和维护。



## 4、详细设计

> [一份全面的“详细设计说明书”是怎样的？](http://www.woshipm.com/pd/2537763.html)
>
> [概要设计和详细设计相关概念](https://blog.csdn.net/weixin_42119415/article/details/82901615)

详细设计，是软件工程中软件开发的一个步骤，就是对概要设计的一个细化，就是详细设计每个模块实现算法，所需的局部结构。在详细设计阶段，主要是通过需求分析的结果，设计出满足用户需求的软件系统产品。

### **详细设计的基本任务：**

(1)为每个模块进行详细的**算法设计**。用某种图形、表格、语言等工具将每个模块处理过程的详细算法描述出来。

(2)为模块内的数据结构进行设计。对于需求分析、概要设计确定的概念性的数据类型进行确切的定义。

(3)为数据结构进行物理设计，即确定数据库的物理结构。物理结构主要指数据库的存储记录格式、存储记录安排和存储方法，这些都依赖于具体所使用的数据库系统。

(4)其他设计：根据软件系统的类型，还可能要进行以下设计：

①代码设计。为了提高数据的输入、分类、存储、检索等操作，节约内存空间，对数据库中的某些数据项的值要进行代码设计。

②输入/输出格式设计。

③人机对话设计。对于一个实时系统，用户与计算机频繁对话，因此要进行对话方式、内容、格式的具体设计。

(5)详细设计说明书。

(6)评审。对处理过程的算法和数据库的物理结构都要评审。

软件设计采用自顶向下、逐次功能展开的设计方法，首先完成总体设计，然后完成各有机组成部分的设计。

概要设计实现软件的总体设计、模块划分、用户界面设计、数据库设计等等；详细设计则根据概要设计所做的模块划分，实现各模块的算法设计，实现用户界面设计、数据结构设计的细化，等等。

概要设计里的功能应该是重点在功能描述，对需求的解释和整合，整体划分功能模块，并对各功能模块进行详细的图文描述，应该让读者大致了解系统做完后大体的 结构和操作模式。详细设计则是重点在描述系统的实现方式，各模块详细说明实现功能所需的类及具体的方法函数，包括涉及到的sql语句等。



## 5、测试用例评审

> [如何做测试用例评审](https://blog.csdn.net/alice_tl/article/details/80218379)
>
> [编写测试用例](https://blog.csdn.net/sdr_zd/article/details/70453027)
>
> [用例评审](https://blog.csdn.net/wylxhwxn1314/article/details/91313609)

测试用例(Test Case)是指对一项特定的软件产品进行测试任务的描述，体现测试方案、方法、技术和策略。其内容包括测试目标、测试环境、输入数据、测试步骤、预期结果、测试脚本等，最终形成文档。简单地认为，测试用例是为某个特殊目标而编制的一组测试输入、执行条件以及预期结果，用于核实是否满足某个特定软件需求。

### **测试用例设计原则：**

测试用例是一个文档，是执行的最小实体。测试用例包括输入、动作、时间和一个期望的结果，其目的是确定应用程序的某个特性是否可正常工作，并且达到程序所设计的结果，以便测试某个程序路径或核实是否满足某个特定需求般在进行测试用例设计前要全面了解被测试产品的功能、明确测试范围(特别是要明确哪些是不需要测试的)、具备基本的测试技术与方法等。测试用例设计一般遵循以下原则: 

(1)正确性。输入用户实际数据以验证系统是否满足需求规格说明书的要求;测试用例中的测试点应首先保证要至少覆盖需求规格说明书中的各项功能，并且正常。

(2)全面性。覆盖所有的需求功能项;设计的用例除对测试点本身的测试外，还需考虑用户实际使用的情况、与其他部分关联使用的情况、非正常情况(不合理、非法、越界以及极限输入数据)操作和环境设置等。 

(3)连贯性。用例组织有条理、主次分明，尤其体现在业务测试用例上;用例执行粒度尽量保持每个用例都有测点，不能同时覆盖很多功能点，否则执行起来牵连太大，所以每个用例间保持连贯性很重要。

(4)可判定性。测试执行结果的正确性是可判定的，每一个测试用例都有相应的期望结果。

(5)可操作性。测试用例中要写清楚测试的操作步骤，以及与不同的操作步骤相对应的测试结果

### **测试用例设计方法：**

1、白盒法

白盒测试又称结构测试、透明盒测试、逻辑驱动测试或基于代码的测试。白盒法全面了解程序内部逻辑结构、对所有逻辑路径进行测试。其基本思想是把程序看作是路径的集合。这样，对程序的测试便转化为对程序中某些路径的测试，要设法让被测程序的“各处”均被执行到，使潜伏在程序每个角落的错误均有机会暴露出来。因此，白盒法实际上是一种选择通过指定路径的输入数据的分析方法。

2、测试覆盖率

采用白盒法可以用测试覆盖率作为测试彻底度的定量衡量标准。常用的覆盖率有: 

(1)语句覆盖:要求设计足够的测试数据，使程序的每条语句都至少执行一次。 

(2)判定覆盖(分支覆盖):使程序中的每个判定至少出现一次“真值”和一次假值”，即程序中的每个判定(分支)都至少要经过一次。   

(3)条件覆盖:使判定中每个条件的所有可能的结果至少出现一次，并且使每条语句至少执行一次。   

(4)判定条件覆盖:使判定覆盖和条件覆盖同时得到满足。   

(5)多重条件覆盖:又称条件的组合覆盖，是使程序中每个判定中的条件的各种组合都至少取到一次，并且每条语句至少执行一次。   

此外，还有诸如路径覆盖(程序中每条路径至少执行一次)、基本路径覆盖(循环次数只考虑小于等于一次所组成的程序路径，每条基本路径至少执行一次)等。为了获取测试覆盖率(不论是哪一种覆盖率)需要有测试工具的帮助，且需要花费人力与机时去做测试工作(设计测试用例、输入测试数据、进行统计计算等。   

3、黑盒法

黑盒测试也称功能测试，黑盒测试着眼于程序外部结构，不考虑内部逻辑结构，主要针对软件界面和软件功能进行测试。是根据软件需求说明书上罗列的各项功能、性能指标，来构造测试用例的输入数据，实际执行被测软件，分析执行过程的行为与执行结果以便检查出被测软件的错误。在黑盒法测试中，测试者可以完全不关心程序的内部结构。可见，白盒法是一种逻辑驱动方法，而黑盒法是一种功能驱动方法。黑盒法是最常用的测试方法。



## 6、前后端联调

> [前后端分离](https://www.cnblogs.com/yunshangwuyou/p/9534353.html)
>
> [阿里Mock平台](http://www.sohu.com/a/203509447_612370)



## 7、提交测试

> [提测申请流程](https://blog.51cto.com/hongz/2438420)
>
> [开发提测内容规范](https://mp.weixin.qq.com/s/8gqNhj5MrstNLIaWiTLW8g)

### **开发提测标准：**

1、编译及单元测试通过（单模块测试）；
2、通过了冒烟测试(关键功能的测试)，依据测试用例主要业务流程测试通过（系统测试）；
3、显而易见/基本功能不能超过1个（数量待定）；
4、原代码放在版本库中；
5、提供完整、详细、准确版本更新内容；
6、需求及设计开发文档齐备；



## 8、发布计划

> [敏捷产品管理之发布、迭代计划](https://www.jianshu.com/p/126c27c0ce2c)



## 9、code_review

> [如何高效迅速的进行CodeReview](https://www.jianshu.com/p/e9f9aef9a0e9)
>
> [大家的公司的 Code Review 都是怎么做的？遇到过哪些问题？ - 程序员客栈的回答 - 知乎](https://www.zhihu.com/question/41089988/answer/544543949)

### **CodeReview的目标和原则：**

CodeReview的目的是提升代码质量，尽早发现潜在缺陷与BUG，降低修复成本，同时促进团队内部知识共享，帮助更多人更好地理解系统。

- **发现代码的正确性**

代码审查用意是在代码提交前找到其中的问题——你要发现的是它的**正确性**。在代码审查中最常犯的错误—几乎每个新手都会犯的错误是，审查者根据自己的编程习惯来评判别人的代码。

- **不仅是在Review Code，更是在分享和学习**

Code Review最重要的是讲解者分享业务流程和设计思路，参与者通过这些讲解获得这些信息，使得更多人理解这个系统，提升团队整体水平，使得团队维护代码的能力提升。

- **高效迅速完成CodeReview**

我们不能为了应付匆匆忙忙的进行一次代码审查，效率也是很重要的，如果不能保证Code Review目的实现，那么评审便是徒劳的。

**如何高效完成CodeReview？**

参与者要检查设计的合理性以及业务逻辑是否错误，检查代码可读性；讲解者要想办法分享设计、技术、经验等知识。

**1.检查设计的合理性和业务逻辑的正确性：**

- **代码的设计是否符合设计要求**
- **业务逻辑是否正确**
- **关注业务可拓展性**
- **关注使用到的数据结构、设计模式和代码性能**

**2.检查代码可读性和可维护性**

**3.分享设计、技术、知识和经验**

 ## 10、灰度上线

> [从腾讯的“灰度机制”到产品的“灰度上线”，你了解多少？](http://www.woshipm.com/pd/263558.html/comment-page-1)
>
> [网关实现灰度发布](https://segmentfault.com/a/1190000017894943)

灰度上线，简单点理解就是按产品需求优先级，抽出核心需求，在满足用户基本要求的情况下快速上线，并通过限制流量、白名单等机制进行产品试用，以此收集用户的意见，从而萃取出用户潜在的需求，形成后续更有针对性的设计方案。

### 一、背景
互联网产品开发有个非常特别的地方，就是不停的升级，升级，再升级。采用敏捷开发的方式，基本上保持每周或者每两周一次的发布频率，系统升级总是伴随着各种风险，新旧版本兼容的风险，用户使用习惯突然改变而造成用户流失的风险，系统宕机的风险，500错误服务不可用的风险等等。为了避免这些风险，很多产品都采用了灰度发布的策略，其主要思想就是把影响集中到一个点，然后再发散到一个面，出现意外情况后很容易就回退，即使影响也是可控的。
任何脱离实际业务的技术工作都是耍流氓，技术需要服务于业务。因此，本文尽量淡化了业务方面的因素，聚焦于技术层面，建议在实际运用中还是要根据各自的业务场景去变化和调整。

### 二、什么是灰度
灰度发布是指在黑与白之间，能够平滑过渡的一种发布方式。AB test就是一种灰度发布方式，让一部分用户继续用A，一部分用户开始用B，如果用户对B没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到B上面来。灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度。
互联网系统，灰度其实就是根据设定的规则将请求路由到我们的灰度版本（灰度机器）上来。比如对于API来说，一般有如下几个需求：特定用户（比如测试帐号）、 特定的App（比如测试app或者合作App）、特定的模块、接口（只有某些接口需要灰度，这种一般是API Container的修改，拿一些不是很重要的API做灰度测试）、特定的机器（某些请求IP转发到灰度机）等。

### 三、灰度的优势
1、 在发布过程中降低上线风险
2、 降低影响范围，并且范围可控
3、 降低对测试的依赖，减少线下自测的数据构造成本
4、 特定的请求能够指向特定的服务器，方便集中监控日志，方便跟踪完整的调用链路
5、 方便系统流量切入
6、 便于随时回滚
7、 指定特定人群，方便系统回访，方便产品需求收集，完善产品功能，提升产品质量
8、 在无状态的情况下保障用户使用到的版本一致
9、 避免宕机给用户带来不好的体验和使用

### 四、目标
1、 做到对现有业务系统无侵入性
2、 能够发挥以上提到的灰度的优势
3、 发布系统的灵活配置
4、 发布系统和业务系统的松耦合
5、 和网关系统结合，让操作平滑

### 五、功能
1、 路由策略管理/配置
2、 灰度规则管理
3、 开启/关闭开关

### 六、系统设计
需要设计的系统分为两种场景，一种是http方式接入，需要借助网关(gate-way)去实现流量的切换，和系统路由；另一种是rpc接入(目前为dubbo)，需要借助dubbo提供的负载均衡策略
来实现，结合自带的qos(dubbo的在线运维命令)实现服务启动/关闭。
【说明】：服务内部执行线程监控待定，sentinel 、 pinpoint or other。

1、http方式接入

![图片描述](./static/http方式接入.png)

其中分为几个重要的部分：
接入层网关，接入客户端请求，根据下发的配置将符合条件的请求转发到新旧系统上．
配置管理后台，这个后台可以配置不同的转发策略给接入层网关．
稳定和灰度两种处理客户端请求的业务服务器．

http请求的入口都落在网关上，网关会根据管控平台(admin dashboard)的配置进行uri的选择。此时请求数据会判断当前应用是否已经开启灰度，再次判断是应用级别的灰度还是服务级别的灰度，然后根据管控平台配置的灰度策略进行灰度，可以支持白名单、权重、ip段、业务域等。
管控平台会调用引擎管理执行相应的指令，进行关闭、开启、更新策略和白名单数据等，每次网关重新reload和重启时会从灰度管理系统调用接口读取配置应用的信息，加入缓存。
为了提升性能，应用的基本信息、灰度策略、白名单等数据缓存在内存或者类redis这样的缓冲中，灵活的进行缓存数据的更新。
实现功能：
1、动态路由
2、服务动态编排，实现流量的自由切换
3、启服/停服
4、服务自检

2、rpc(dubbo)接入

如果直接停机重启rpc service会有什么影响：
服务发布时，直接重启Tomcat，导致节点正在处理的请求会受到影响，严重时会有数据异常。
服务发布时如果节点正在作为task_tracker运行lts任务，会导致任务失败并retry。
服务发布时如果节点正在消费RocketMQ中的消息，会导致消息消费异常，甚至进入retry或dlq队列。
服务发布完成后没有即时验证机制，直接暴露给用户，如有异常影响面很广。
线上无法同时存在新老版本的服务来用于长时间的验证。
竟然有这么多问题，想想就可怕，泪崩~,因此必须想法优雅的实现服务的启停，因此引出dubbo 服务的持续发布：
![图片描述](./static/dubbo服务持续发布.png)
dubbo-consumer实现不同的负载均衡，在负载的时候进行白名单校验和策略选择。系统对灰度管控平台非强制依赖，管控平台出现问题不影响系统正常运行。
负载动态路由，阻止后续流量进入，监控服务是否还有执行的线程，加入钩子offline服务或者接口，进行服务升级，自检，启动online，接入负载均衡。

由于很多接口都有在Dubbo中进行注册，因此需要有办法能够对其Provider Service接口进行下线或屏蔽，使其不提供服务，即其它服务无法调用它的接口。
Service接口下线后，此consumer机器自然无任何流量流入，因此也无流量返回，达到下线consumer机器的目的，然后即可部署代码。
官方有提供Dubbo-Admin工具，用于对Dubbo中各APP及其Service接口进行管理，里面自然也包含有实现下线的功能，可以有3种方法：
屏蔽，貌似一直没有效果(尴尬)；
禁用，可以成功禁用；
权重调节，可以设置0-100的权重，设置为0时即不提供服务。

![图片描述](./static/dubbo权重调节.png)
经过权重调节方案，通过Dubbo-Admin对需要下线机器的APP应用接口权限设置为0。

实现的功能：
1、缓存负载策略
在系统启动的时候要根据系统配置拉取灰度策略，并且保存在内存中，定时获取最新的负载策略，需要提供及时触发的策略更新接口。
2、 负载均衡
在系统上线之前选择运行时使用的负载均衡进行调用。
3、系统配置
系统在上线前需要录入管控平台，并且完成相应的配置，在启动的时候作为唯一标识能够拉取相应的配置。
4、监控和统计
系统在内存中缓存统计信息，定时上传管控平台，监控出现问题不影响系统正常使用（sentinel,or dubbo-amdin模块扩展）。
5、qos运维工具
系统的启动使用qos，停服采用延时关闭结合jvm钩子。

### 七、检查机制

为了平滑发布的顺利进行，检查确认机制不可或缺，即确保Dubbo/Http中的下线都已生效，并且无流量发生，我们从以下两个维度去检查：

接口检查，调用Dubbo、Http的API接口，检查业务服务机器状态，是否为已经下线。当然，在做了下线功能的同时，我们也有检查功能和上线功能，可供调用。
监控检查，调用监控平台(ELK)的API接口，检查业务服务机器的请求访问数和日志流量是否都已经为0，已经处于下线状态。
经过上述改造后，我们新的发布流程如下，基本解决了平滑发布问题，发布时对业务的影响降到了最低；

### 八、停服/启服后小范围验证
1.灰度验证--不影响线上用户
2.部分实例发布-- 导部分流量到新实例（可通过网关路由规则：用户ID取模，区域限制等等）
3.全部发布

## 11、生产环境上线

> [生产环境发布常见问题](https://www.jianshu.com/p/2c3beb523190)

### 发布生产（online）常见问题总结：

1，新上线应用或者新的迭代有新的网络访问路径，在上线前，没有打通和其他应用之间的网络访问权限。

2，项目中的配置信息没有切换到生产环境（日志路径，配置文件信息或者配置文件中部分信息）。

3，数据库需要执行的DDL，或者DML数据没有执行（或许只执行了部分语句）。

4，依赖应用的接口有改动（迁移机房导致域名或者ip变动，导致数据访问不到），但是并没有通知到，所以导致网络环境之间不通。

5，迭代开发，导致新的需求，对老的线上的需求有影响。

6，数据库的sql，部分的查询语句，有串库现象，导致部分语句执行不成功（常常出现的情况，上生产的时候，sql语句里面包括测试环境的用户），这种情况可以通过全局搜索测试环境数据库的用户名，如“mysqluat”，可以通过这种方式排出。

7，生产分布式环境配置和测试环境单机不一致，可能需要对配置信息作特殊处理。

8，前端调用接口，返回的数据不准确，

8.1，可能是缓存的问题，先排除缓存的影响。

8.2，接口参数问题，参数的名称，类型，

8.3，网络抖动引起的问题

以上问题基本都可以通过postman等其他的接口调用工具，测试接口是否有问题，如果没有问题，问题基本定位在前端。

9，项目外部的一些环境基础。如需要在项目的同级目录创建文件夹用于存储上传的文件，但是在生产环境没有创建。

10，java代码中调用的配置信息被写死，没有根据环境的不同调用不同的配置文件。例如把某个接口的调用地址，写死的是测试环境的，这种情况可以发布之前全局搜索有没有“http”相关的字符在java文件中。

11，抛给前端的信息，一定是经过处理的，用户可以理解的消息，需要做全局的异常处理（可以根据不同的异常类作不同的处理）。

## 12、线上日志观察

> [如何查看线上服务器日志](https://blog.csdn.net/u010802778/article/details/88378951)
>
> [线上日志集中化可视化管理：ELK](https://www.cnblogs.com/163yun/p/9722657.html)